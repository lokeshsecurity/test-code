/************************************************************************************
GBS - DDL Script (Milestone 3) */
 -----------------------------------------------------------------------------------------Tables----------------------------------------------------------------------------------------

ALTER TABLE GBS.MEMBER
ADD NOTIFICATION_BEFORE        	INTEGER,
    NOTIFICATION_EVERY         	INTEGER

/************************************************************************************************************************/

ALTER TABLE GBS.MEMBER_HISTORY
ADD NOTIFICATION_BEFORE        	INTEGER,
    NOTIFICATION_EVERY         	INTEGER
/************************************************************************************************************************/

ALTER TABLE GBS.MEMBER_HISTORY
ADD MEMBER_ID        	INTEGER,
    NOTIFICATION_TYPE	VARCHAR(255)
/************************************************************************************************************************/

ALTER TABLE GBS.BOARD_HISTORY
ADD NOTIFICATION_DATE	TIMESTAMP

/************************************************************************************************************************/

ALTER TABLE GBS.MEMBER_HISTORY
ADD NOTIFICATION_DATE	TIMESTAMP

/************************************************************************************************************************/
ALTER TABLE GBS.NOTIFICATION
ADD MEMBER_ID        	INTEGER,
    NOTIFICATION_TYPE	VARCHAR(255)
------------------------------------------------------------------------------VIEWS----------------------------------------------------------------------------------------

CREATE OR REPLACE VIEW GBS.MEMBERS AS
select MEMBER.MEMBER_ID,
  MEMBER.CPR_NUMBER,
  MEMBER.BOARD_ID,
  BOARD.BOARD_NAME,
  BOARD.BOARD_NAME_NORMALIZED,
  MEMBER.MEMBER_NAME,
  MEMBER.MEMBER_NAME_NORMALIZED,
  MEMBER.MEMBER_OCCUPATION,
  MEMBER.MEMBER_OCCUPATION_NORMLIZED,
  MEMBER.MEMBER_START_DATE,
  MEMBER.MEMBER_END_DATE,
  MEMBER.STATUS_ID,
  MEMBER.NOTIFICATION_BEFORE,
  MEMBER.NOTIFICATION_EVERY,
  STATUS.STATUS_NAME,
  ORGANIZATIONS.ORGANIZATION_ID,
  ORGANIZATIONS.ORGANIZATION_NAME,
  ORGANIZATIONS.ORGANIZATION_NAME_NORMALIZED,
  ORGANIZATION_OBF.ORGANIZATION_ID      ORGANIZATION_ID_OBF,
  ORGANIZATION_OBF.ORGANIZATION_NAME    ORGANIZATION_NAME_OBF,
  ORGANIZATION_OBF.ORGANIZATION_NAME_NORMALIZED   ORGANIZATION_NAME_NORMALIZED_OBF,
  ROLE.ROLE_ID,
  ROLE.ROLE_NAME,
  MEMBER.CREATED_BY MEMBER_CREATED_BY,
  MEMBER.CREATED_ON MEMBER_CREATED_ON,
  MEMBER.UPDATED_ON MEMBER_UPDATED_ON,
  MEMBER.UPDATED_BY MEMBER_UPDATED_BY 
from GBS.MEMBER MEMBER 
    INNER JOIN GBS.STATUS STATUS ON  MEMBER.STATUS_ID = STATUS.STATUS_ID
    LEFT OUTER JOIN GBS.ROLE ROLE ON  ROLE.ROLE_ID = MEMBER.ROLE_ID 
    LEFT OUTER JOIN GBS.ORGANIZATIONS ORGANIZATIONS ON ORGANIZATIONS.ORGANIZATION_ID = MEMBER.ORGANIZATION_ID
    LEFT OUTER JOIN GBS.ORGANIZATIONS ORGANIZATION_OBF ON ORGANIZATION_OBF.ORGANIZATION_ID = MEMBER.ORGANIZATION_ON_BEHALF_ID
    INNER JOIN GBS.BOARD BOARD ON BOARD.BOARD_ID = MEMBER.BOARD_ID
GO

/************************************************************************************************************************/
CREATE OR REPLACE VIEW GBS.MEMBERS_DECREES AS 
select MEMBERS.MEMBER_ID,
  MEMBERS.BOARD_ID,
  MEMBERS.BOARD_NAME,
  MEMBERS.BOARD_NAME_NORMALIZED,
  MEMBERS.MEMBER_NAME,
  MEMBERS.MEMBER_NAME_NORMALIZED,
  MEMBERS.MEMBER_OCCUPATION,
  MEMBERS.MEMBER_OCCUPATION_NORMLIZED,
  MEMBERS.MEMBER_START_DATE,
  MEMBERS.MEMBER_END_DATE,
  MEMBERS.STATUS_ID MEMBER_STATUS_ID,
  MEMBERS.STATUS_NAME,
  MEMBERS.ORGANIZATION_ID,
  MEMBERS.ORGANIZATION_NAME,
  MEMBERS.ORGANIZATION_NAME_NORMALIZED,
  MEMBERS.MEMBER_CREATED_BY,
  MEMBERS.MEMBER_CREATED_ON,
  MEMBERS.MEMBER_UPDATED_ON,
  MEMBERS.MEMBER_UPDATED_BY,
  DECREE.DECREE_ID,
  DECREE.DECREE_NUMBER,
  DECREE.DECREE_YEAR,
  DECREE.DECREE_DESCRIPTION,
  DECREE.DECREE_DESCRIPTION_NORMALIZE ,
  DECREE.DECREE_TYPE_ID,
  ATTACHMENT.ATTACHMENT_ID

from GBS.DECREE DECREE 
    inner join GBS.MEMBER_DECREE MEMBER_DECREE 
    on DECREE.DECREE_ID = MEMBER_DECREE.DECREE_ID 
    inner join GBS.MEMBERS MEMBERS 
    on MEMBER_DECREE.MEMBER_ID = MEMBERS.MEMBER_ID
  LEFT OUTER JOIN GBS.ATTACHMENT ATTACHMENT
ON DECREE.DECREE_ID = ATTACHMENT.DECREE_ID
GO
/************************************************************************************************************************/

CREATE or REPLACE VIEW GBS.BOARDS_MEMBERS AS
select BOARDS.BOARD_ID,
  BOARDS.BOARD_NAME,
  BOARDS.BOARD_NAME_NORMALIZED,
  BOARDS.STATUS_ID BOARD_STATUS_ID,
  BOARDS.STATUS_NAME BOARD_STATUS_NAME,
  BOARDS.BOARD_EXPIRY_DATE,
  BOARDS.BOARD_CREATED_ON,
  BOARDS.BOARD_UPDATED_BY,
  BOARDS.BOARD_UPDATED_ON,
  BOARDS.SOURCE_ORGANIZATION_ID,
  BOARDS.SOURCE_ORGANIZATION_NAME,
  BOARDS.SOURCE_ORGANIZATION_NAME_NORMALIZED,
  MEMBERS.MEMBER_ID,
  MEMBERS.MEMBER_NAME,
  MEMBERS.MEMBER_NAME_NORMALIZED,
  MEMBERS.MEMBER_OCCUPATION,
  MEMBERS.MEMBER_OCCUPATION_NORMLIZED,
  MEMBERS.MEMBER_START_DATE,
  MEMBERS.MEMBER_END_DATE,
  MEMBERS.STATUS_ID MEMBER_STATUS_ID,
  MEMBERS.STATUS_NAME MEMBER_STATUS_NAME,
  MEMBERS.ORGANIZATION_ID MEMBER_ORGANIZATION_ID,
  MEMBERS.ORGANIZATION_NAME MEMBER_ORGANIZATION_NAME,
  MEMBERS.ORGANIZATION_NAME_NORMALIZED MEMBER_ORGANIZATION_NAME_NORMALIZED,
  MEMBERS.ROLE_ID,
  MEMBERS.ROLE_NAME,
  MEMBERS.MEMBER_CREATED_BY,
  MEMBERS.MEMBER_CREATED_ON,
  MEMBERS.MEMBER_UPDATED_ON,
  MEMBERS.MEMBER_UPDATED_BY,
  MEMBERS.NOTIFICATION_BEFORE,
  MEMBERS.NOTIFICATION_EVERY
from GBS.BOARDS BOARDS 
    inner join GBS.MEMBERS MEMBERS 
    on BOARDS.BOARD_ID = MEMBERS.BOARD_ID
GO

/************************************************************************************************************************/


CREATE OR REPLACE VIEW GBS.BOARDS_NOTIFICATIONS 
AS
select BOARDS.BOARD_ID,
  BOARDS.BOARD_NAME,
  BOARDS.BOARD_NAME_NORMALIZED,
  BOARDS.PARENT_BOARD_ID,
  BOARDS.BOARD_TYPE_ID,
  BOARDS.BOARD_TYPE_NAME,
  BOARDS.STATUS_ID,
  BOARDS.STATUS_NAME,
  BOARDS.SOURCE_ORGANIZATION_NAME,
  BOARDS.SOURCE_ORGANIZATION_ID,
  BOARDS.BOARD_EXPIRY_DATE,
  BOARDS.BOARD_START_DATE,
  NOTIFICATIONS.ACTUAL_DATE,
  NOTIFICATIONS.NOTIFICATION_ID,
  NOTIFICATIONS.LAST_RUN_DATE,
  NOTIFICATIONS.REPEAT_EVERY,
  NOTIFICATIONS.NOTIFICATION_DATE,
  NOTIFICATIONS.MEMBER_ID,
  NOTIFICATIONS.NOTIFICATION_TYPE
from GBS.BOARDS BOARDS 
    inner join GBS.NOTIFICATIONS NOTIFICATIONS 
    on BOARDS.BOARD_ID = NOTIFICATIONS.BOARD_ID
GO

/************************************************************************************************************************/


CREATE OR REPLACE VIEW GBS.MEMBERS_DECREES AS 
select MEMBERS.MEMBER_ID,
  MEMBERS.BOARD_ID,
  MEMBERS.BOARD_NAME,
  MEMBERS.BOARD_NAME_NORMALIZED,
  MEMBERS.MEMBER_NAME,
  MEMBERS.MEMBER_NAME_NORMALIZED,
  MEMBERS.MEMBER_OCCUPATION,
  MEMBERS.MEMBER_OCCUPATION_NORMLIZED,
  MEMBERS.MEMBER_START_DATE,
  MEMBERS.MEMBER_END_DATE,
  MEMBERS.STATUS_ID MEMBER_STATUS_ID,
  MEMBERS.STATUS_NAME,
  MEMBERS.ORGANIZATION_ID,
  MEMBERS.ORGANIZATION_NAME,
  MEMBERS.ORGANIZATION_NAME_NORMALIZED,
  MEMBERS.MEMBER_CREATED_BY,
  MEMBERS.MEMBER_CREATED_ON,
  MEMBERS.MEMBER_UPDATED_ON,
  MEMBERS.MEMBER_UPDATED_BY,
  DECREE.DECREE_ID,
  DECREE.DECREE_NUMBER,
  DECREE.DECREE_YEAR,
  DECREE.DECREE_DESCRIPTION,
  DECREE.DECREE_DESCRIPTION_NORMALIZE ,
  DECREE.DECREE_TYPE_ID,
  ATTACHMENT.ATTACHMENT_ID,
  ATTACHMENT.ATTACHMENT_TYPE_ID

from GBS.DECREE DECREE 
    inner join GBS.MEMBER_DECREE MEMBER_DECREE 
    on DECREE.DECREE_ID = MEMBER_DECREE.DECREE_ID 
    inner join GBS.MEMBERS MEMBERS 
    on MEMBER_DECREE.MEMBER_ID = MEMBERS.MEMBER_ID
  LEFT OUTER JOIN GBS.ATTACHMENT ATTACHMENT
ON DECREE.DECREE_ID = ATTACHMENT.DECREE_ID
GO

/************************************************************************************************************************/

CREATE OR REPLACE VIEW GBS.BOARDS_MEMBERS_NOTIFICATIONS 
AS
select 
  MEMBER.MEMBER_NAME,
  MEMBER.MEMBER_ID,
  MEMBER.ROLE_NAME,
  MEMBER.MEMBER_END_DATE,
  BOARD.BOARD_ID,
  BOARD.BOARD_NAME,
  BOARD.BOARD_NAME_NORMALIZED,
  BOARD.PARENT_BOARD_ID,
  BOARD.BOARD_TYPE_ID,
  BOARD.BOARD_TYPE_NAME,
  BOARD.STATUS_ID,
  BOARD.STATUS_NAME,
  BOARD.SOURCE_ORGANIZATION_NAME,
  BOARD.SOURCE_ORGANIZATION_ID,
  BOARD.BOARD_EXPIRY_DATE,
  BOARD.BOARD_START_DATE,
  NOTIFICATIONS.ACTUAL_DATE,
  NOTIFICATIONS.NOTIFICATION_ID,
  NOTIFICATIONS.LAST_RUN_DATE,
  NOTIFICATIONS.REPEAT_EVERY,
  NOTIFICATIONS.NOTIFICATION_DATE,
  NOTIFICATIONS.NOTIFICATION_TYPE,
  NOTIFICATIONS.SUBSCRIBER_EMAIL
from GBS.NOTIFICATIONS NOTIFICATIONS 
left join GBS.MEMBERS MEMBER on NOTIFICATIONS.MEMBER_ID = MEMBER.MEMBER_ID 
left join  GBS.BOARDS BOARD on NOTIFICATIONS.BOARD_ID = BOARD.BOARD_ID
GO
/************************************************************************************************************************/

CREATE OR REPLACE VIEW GBS.BOARDS_DECREES_ATTACHMENTS AS
select BOARDS.BOARD_ID,
  BOARDS.BOARD_NAME,
  BOARDS.BOARD_NAME_NORMALIZED,
  BOARDS.BOARD_TYPE_ID,
  BOARDS.BOARD_TYPE_NAME,
  BOARDS.GOVERNMENT_BOARD_TYPE_ID,
  BOARDS.STATUS_ID,
  BOARDS.STATUS_NAME,
  BOARDS.BOARD_START_DATE,
  BOARDS.BOARD_EXPIRY_DATE,
  BOARDS.BOARD_CREATED_BY,
  BOARDS.BOARD_CREATED_ON,
  BOARDS.BOARD_UPDATED_BY,
  BOARDS.BOARD_UPDATED_ON,
  BOARDS.SOURCE_ORGANIZATION_ID,
  BOARDS.SOURCE_ORGANIZATION_NAME,
  BOARDS.SOURCE_ORGANIZATION_NAME_NORMALIZED,
  DECREE.DECREE_ID,
  DECREE.DECREE_NUMBER,
  DECREE.DECREE_YEAR,
  DECREE.DECREE_TYPE_ID,
  (SELECT DT.DECREE_TYPE_NAME FROM GBS.DECREE_TYPE DT WHERE DT.DECREE_TYPE_ID = DECREE.DECREE_TYPE_ID) AS DECREE_TYPE_NAME,
  DECREE.DECREE_DESCRIPTION,
  DECREE.DECREE_DESCRIPTION_NORMALIZE,
  DECREE.ISSUE_DATE_MELADY,
  DECREE.ISSUE_DATE_HIGRY,
  ATTACHMENT.ATTACHMENT_ID,
  ATTACHMENT.ATTACHMENT_NAME,
  ATTACHMENT.ATTACHMENT_NAME_NORMALIZED,
  ATTACHMENT.ATTACHMENT_MIME,
  ATTACHMENT.ATTACHMENT_SIZE,
  ATTACHMENT.ATTACHMENT_TYPE_ID,
  ATTACHMENT.CREATED_ON,
 (SELECT ORGANIZATION_NAME FROM GBS.BOARD_PRIMARY_DESTINATION_ORGANIZATION DESO WHERE DESO.BOARD_ID = BOARDS.BOARD_ID ) AS PRIMARY_DESTINATION_ORGANIZATION

FROM GBS.BOARDS BOARDS 
LEFT OUTER JOIN GBS.BOARD_DECREE BOARD_DECREE 
ON BOARDS.BOARD_ID = BOARD_DECREE.BOARD_ID
LEFT OUTER JOIN GBS.DECREE DECREE 
on BOARD_DECREE.DECREE_ID = DECREE.DECREE_ID 
LEFT OUTER JOIN GBS.ATTACHMENT ATTACHMENT
ON DECREE.DECREE_ID = ATTACHMENT.DECREE_ID
GO
